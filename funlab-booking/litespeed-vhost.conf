# ═══════════════════════════════════════════════════════════
# CONFIGURATION LITESPEED OPTIMISÉE - FUNLAB BOOKING
# ═══════════════════════════════════════════════════════════
# Fichier: /usr/local/lsws/conf/vhosts/funlab.faltaagency.com/vhost.conf

docRoot                   /home/faltaagency.com/funlab.faltaagency.com/funlab-booking/public
vhDomain                  funlab.faltaagency.com
vhAliases                 www.funlab.faltaagency.com
adminEmails               maizakoussai@gmail.com
enableGzip                1
enableIpGeo               1

index  {
  useServer               0
  indexFiles              index.php, index.html
}

errorlog /home/faltaagency.com/funlab.faltaagency.com/logs/error.log {
  useServer               0
  logLevel                ERROR
  rollingSize             10M
}

accesslog /home/faltaagency.com/funlab.faltaagency.com/logs/access.log {
  useServer               0
  logFormat               "%h %l %u %t "%r" %>s %b "%{Referer}i" "%{User-Agent}i""
  logHeaders              5
  rollingSize             10M
  keepDays                30
  compressArchive         1
}

# ═══════════════════════════════════════════════════════════
# CONFIGURATION PHP - CRITIQUE POUR CODEIGNITER 4
# ═══════════════════════════════════════════════════════════
phpIniOverride  {
# Chemins autorisés (open_basedir) - AJUSTER SI ERREUR
php_admin_value open_basedir "/tmp:/home/faltaagency.com/funlab.faltaagency.com/funlab-booking:/usr/local/lsws/lsphp85/lib/php"

# Mémoire et performance
php_value memory_limit 256M
php_value max_execution_time 300
php_value max_input_time 300

# Upload de fichiers
php_value post_max_size 20M
php_value upload_max_filesize 20M

# Affichage des erreurs (DÉSACTIVER EN PRODUCTION)
php_value display_errors Off
php_value display_startup_errors Off
php_value error_reporting E_ALL
php_value log_errors On
php_value error_log "/home/faltaagency.com/funlab.faltaagency.com/logs/php-error.log"

# Session
php_value session.save_path "/home/faltaagency.com/funlab.faltaagency.com/funlab-booking/writable/session"

# Timezone
php_value date.timezone "Africa/Tunis"
}

# ═══════════════════════════════════════════════════════════
# MODULE CACHE LITESPEED
# ═══════════════════════════════════════════════════════════
module cache {
  storagePath /home/faltaagency.com/funlab.faltaagency.com/lscache
  checkPublicCache 1
  checkPrivateCache 1
  maxCacheObjSize 10000000
  maxStaleAge 200
  qsCache 1
}

# ═══════════════════════════════════════════════════════════
# PROCESSEUR PHP EXTERNE (LSAPI)
# ═══════════════════════════════════════════════════════════
scripthandler  {
  add                     lsapi:falta48086569 php
}

extprocessor falta48086569 {
  type                    lsapi
  address                 UDS://tmp/lshttpd/falta48086569.sock
  maxConns                10
  env                     LSAPI_CHILDREN=10
  initTimeout             60
  retryTimeout            0
  persistConn             1
  pcKeepAliveTimeout      1
  respBuffer              0
  autoStart               1
  path                    /usr/local/lsws/lsphp85/bin/lsphp
  extUser                 falta4808
  extGroup                falta4808
  memSoftLimit            1024M
  memHardLimit            1024M
  procSoftLimit           400
  procHardLimit           500
}

# ═══════════════════════════════════════════════════════════
# RÈGLES DE RÉÉCRITURE (CRITIQUE POUR CODEIGNITER)
# ═══════════════════════════════════════════════════════════
rewrite  {
  enable                  1
  autoLoadHtaccess        1
}

context / {
  location                /home/faltaagency.com/funlab.faltaagency.com/funlab-booking/public
  allowBrowse             0

  rewrite  {
    enable                1
    rules                 <<<END_rules
# Redirection HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Autoriser les fichiers et dossiers existants
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# Rediriger vers index.php (CodeIgniter)
RewriteRule ^(.*)$ index.php/$1 [L]
END_rules
  }
}

# ═══════════════════════════════════════════════════════════
# CONTEXT API (POUR LES ENDPOINTS REST)
# ═══════════════════════════════════════════════════════════
context /api {
  allowBrowse             0
  
  rewrite  {
    enable                1
    rules                 <<<END_rules
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ /index.php/api/$1 [L]
END_rules
  }
}

# ═══════════════════════════════════════════════════════════
# CONTEXT LETS ENCRYPT (RENOUVELLEMENT SSL)
# ═══════════════════════════════════════════════════════════
context /.well-known/acme-challenge {
  location                /usr/local/lsws/Example/html/.well-known/acme-challenge
  allowBrowse             1

  rewrite  {
    enable                0
  }
  addDefaultCharset       off

  phpIniOverride  {
php_admin_value open_basedir "/tmp:/usr/local/lsws/Example/html/.well-known/acme-challenge"
  }
}

# ═══════════════════════════════════════════════════════════
# CONFIGURATION SSL
# ═══════════════════════════════════════════════════════════
vhssl  {
  keyFile                 /etc/letsencrypt/live/funlab.faltaagency.com/privkey.pem
  certFile                /etc/letsencrypt/live/funlab.faltaagency.com/fullchain.pem
  certChain               1
  sslProtocol             24
  enableECDHE             1
  renegProtection         1
  sslSessionCache         1
  enableSpdy              15
  enableStapling          1
  ocspRespMaxAge          86400
}
