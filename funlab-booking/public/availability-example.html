<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FunLab - Exemple d'int√©gration API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .slot-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        .slot-card:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .slot-card.selected {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .slot-time {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }
        .room-badge {
            display: inline-block;
            padding: 5px 10px;
            background-color: #6c757d;
            color: white;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .no-slots {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <h1 class="text-center mb-4">üéÆ R√©servation FunLab</h1>
                
                <!-- Formulaire de s√©lection -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">S√©lectionnez votre activit√©</h5>
                        
                        <div class="mb-3">
                            <label for="game-select" class="form-label">Jeu / Activit√©</label>
                            <select class="form-select" id="game-select">
                                <option value="">-- S√©lectionnez un jeu --</option>
                                <option value="1">Escape Room - Le Myst√®re</option>
                                <option value="2">R√©alit√© Virtuelle</option>
                                <option value="3">Laser Game</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="date-picker" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date-picker" min="">
                        </div>
                        
                        <button class="btn btn-primary w-100" id="search-btn">
                            üîç Rechercher les cr√©neaux disponibles
                        </button>
                    </div>
                </div>
                
                <!-- Zone d'affichage des r√©sultats -->
                <div id="results-container" style="display: none;">
                    <h5 class="mb-3">Cr√©neaux disponibles</h5>
                    <div id="slots-container"></div>
                    
                    <div class="mt-4">
                        <button class="btn btn-success w-100" id="book-btn" disabled>
                            ‚úÖ Confirmer la r√©servation
                        </button>
                    </div>
                </div>
                
                <!-- Loading spinner -->
                <div id="loading" style="display: none;">
                    <div class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2">Recherche des cr√©neaux disponibles...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = '/api';
        let selectedSlot = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // D√©finir la date minimale √† aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-picker').setAttribute('min', today);
            document.getElementById('date-picker').value = today;
            
            // √âv√©nement de recherche
            document.getElementById('search-btn').addEventListener('click', searchAvailableSlots);
            
            // √âv√©nement de r√©servation
            document.getElementById('book-btn').addEventListener('click', confirmBooking);
        });

        /**
         * Recherche les cr√©neaux disponibles
         */
        async function searchAvailableSlots() {
            const gameId = document.getElementById('game-select').value;
            const date = document.getElementById('date-picker').value;
            
            // Validation
            if (!gameId) {
                alert('Veuillez s√©lectionner un jeu');
                return;
            }
            
            if (!date) {
                alert('Veuillez s√©lectionner une date');
                return;
            }
            
            // Afficher le loading
            showLoading(true);
            hideResults();
            selectedSlot = null;
            
            try {
                // Appel API
                const response = await fetch(
                    `${API_BASE_URL}/availability/slots?game_id=${gameId}&date=${date}`
                );
                
                if (!response.ok) {
                    throw new Error('Erreur r√©seau');
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    displaySlots(result.data);
                } else {
                    showNoSlots('Aucun cr√©neau disponible pour cette date');
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('Une erreur est survenue. Veuillez r√©essayer.');
            } finally {
                showLoading(false);
            }
        }

        /**
         * Affiche les cr√©neaux disponibles
         */
        function displaySlots(slotsData) {
            const container = document.getElementById('slots-container');
            container.innerHTML = '';
            
            // V√©rifier s'il y a des cr√©neaux
            const roomKeys = Object.keys(slotsData);
            
            if (roomKeys.length === 0) {
                showNoSlots('Aucun cr√©neau disponible pour cette date');
                return;
            }
            
            // Afficher les cr√©neaux par salle
            roomKeys.forEach(roomKey => {
                const roomSlots = slotsData[roomKey];
                
                if (roomSlots.length > 0) {
                    // Nom de la salle
                    const roomName = roomSlots[0].room_name;
                    const roomHeader = document.createElement('h6');
                    roomHeader.className = 'mt-3 mb-2';
                    roomHeader.innerHTML = `<span class="room-badge">${roomName}</span>`;
                    container.appendChild(roomHeader);
                    
                    // Cr√©neaux de cette salle
                    roomSlots.forEach(slot => {
                        const slotCard = createSlotCard(slot);
                        container.appendChild(slotCard);
                    });
                }
            });
            
            showResults();
        }

        /**
         * Cr√©e une carte de cr√©neau
         */
        function createSlotCard(slot) {
            const card = document.createElement('div');
            card.className = 'slot-card';
            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div class="slot-time">
                        üïê ${slot.start_formatted} - ${slot.end_formatted}
                    </div>
                    <div>
                        <span class="badge bg-success">Disponible</span>
                    </div>
                </div>
            `;
            
            // √âv√©nement de clic
            card.addEventListener('click', () => selectSlot(card, slot));
            
            return card;
        }

        /**
         * S√©lectionne un cr√©neau
         */
        function selectSlot(cardElement, slot) {
            // D√©s√©lectionner tous les cr√©neaux
            document.querySelectorAll('.slot-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // S√©lectionner ce cr√©neau
            cardElement.classList.add('selected');
            selectedSlot = slot;
            
            // Activer le bouton de r√©servation
            document.getElementById('book-btn').disabled = false;
        }

        /**
         * Confirme la r√©servation (v√©rifie avant)
         */
        async function confirmBooking() {
            if (!selectedSlot) {
                alert('Veuillez s√©lectionner un cr√©neau');
                return;
            }
            
            const gameId = document.getElementById('game-select').value;
            const date = document.getElementById('date-picker').value;
            
            // V√©rifier la disponibilit√© une derni√®re fois
            const checkData = {
                room_id: selectedSlot.room_id,
                game_id: parseInt(gameId),
                date: date,
                start_time: selectedSlot.start,
                end_time: selectedSlot.end
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/availability/check`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(checkData)
                });
                
                const result = await response.json();
                
                if (result.available) {
                    // Cr√©neau toujours disponible
                    alert('‚úÖ Cr√©neau confirm√© ! Redirection vers le formulaire de r√©servation...');
                    
                    // ICI : Redirection vers la page de r√©servation avec les donn√©es
                    // window.location.href = `/booking/create?...`;
                    
                } else {
                    // Cr√©neau plus disponible
                    alert('‚ùå D√©sol√©, ce cr√©neau vient d\'√™tre r√©serv√©. Veuillez en choisir un autre.');
                    searchAvailableSlots(); // Rafra√Æchir
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('Une erreur est survenue. Veuillez r√©essayer.');
            }
        }

        /**
         * Affiche/masque le loading
         */
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        /**
         * Affiche/masque les r√©sultats
         */
        function showResults() {
            document.getElementById('results-container').style.display = 'block';
        }

        function hideResults() {
            document.getElementById('results-container').style.display = 'none';
        }

        /**
         * Affiche un message "aucun cr√©neau"
         */
        function showNoSlots(message) {
            const container = document.getElementById('slots-container');
            container.innerHTML = `
                <div class="no-slots">
                    <p>üòï ${message}</p>
                    <p class="text-muted">Essayez une autre date ou un autre jeu.</p>
                </div>
            `;
            showResults();
        }
    </script>
</body>
</html>
